version: "1.0"
steps:
  main_clone:
    type: "git-clone"
    title: "Cloning kamailio repository"
    repo: "kamailio/kamailio"
    revision: "${{branch}}"
  preps:
    type: freestyle
    title: Build preparation
    image: safarov/kamailio-builder:centos-9
    commands:
    - rm -f kamailio-*.src.rpm ${CF_VOLUME_PATH}/kamailio-*.src.rpm
    - make cfg
    - make -C pkg/kamailio src.rpm
    - mv kamailio-*.src.rpm ${CF_VOLUME_PATH}
    - cd ${CF_VOLUME_PATH}
    - rm -Rf kamailio
    - rm -f Dockerfile.store_rpm
    - wget -q https://raw.githubusercontent.com/kamailio/kamailio-ci/builder/builder/Dockerfile.store_rpm
    - cat Dockerfile.store_rpm
  centos_9:
    type: build
    title: Build CentOS 9 RPMs and store to docker image
    image_name: kamailio/kamailio-store
    tag: ${{branch}}-centos-9.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=centos-9
    no_cache: true
    no_cf_cache: true
    fail_fast: false
  centos_9_webhook:
    title: 'publish CentOS-9 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"centos-9.amd64"}'
      - 'WEBHOOK_TOKEN=${{Auth-Token}}'
    when:
      condition:
        any:
          failed_centos_9: centos_9.result == 'success'
  rhel_10:
    type: build
    title: Build RHEL 10 RPMs and store to docker image
    image_name: kamailio/kamailio-store
    tag: ${{branch}}-rhel-10.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=rhel-10
    no_cache: true
    no_cf_cache: true
    fail_fast: false
  rhel_10_webhook:
    title: 'publish RHEL-10 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"rhel-10.amd64"}'
      - 'WEBHOOK_TOKEN=${{Auth-Token}}'
    when:
      condition:
        any:
          failed_rhel_10: rhel_10.result == 'success'
  print_error_message:
    image: alpine:latest
    title: Marking pipeline status
    commands:
    - echo "RPM build failed"
    - exit 1
    when:
      condition:
        any:
          failed_centos_9: centos_9.result == 'failure'
          failed_rhel_10: rhel_10.result == 'failure'
