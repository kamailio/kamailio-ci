version: "1.0"
steps:
  main_clone:
    type: "git-clone"
    title: "Cloning kamailio repository"
    repo: "${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}"
    revision: "${{CF_REVISION}}"
  preps:
    type: freestyle
    title: Build preparation
    image: safarov/kamailio-builder:centos-7
    commands:
    - rm -f kamailio-*.src.rpm ${CF_VOLUME_PATH}/kamailio-*.src.rpm
    - make cfg
    - make -C pkg/kamailio src.rpm
    - mv kamailio-*.src.rpm ${CF_VOLUME_PATH}
    - cd ${CF_VOLUME_PATH}
    - rm -Rf kamailio
    - rm -f Dockerfile.store_rpm
    - wget -q https://raw.githubusercontent.com/kamailio/kamailio-ci/builder/builder/Dockerfile.store_rpm
    - cat Dockerfile.store_rpm
  fedora_31:
    type: build
    title: Build Fedora 31 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: fedora-31.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=fedora-31
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "fedora", true)
  fedora_31_webhook:
    title: 'publish Fedora-31 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"fedora-31.amd64"}'
    when:
      condition:
        any:
          success_fedora_31: fedora_31.result == 'success'
  fedora_30:
    type: build
    title: Build Fedora 30 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: fedora-30.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=fedora-30
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "fedora", true)
  fedora_30_webhook:
    title: 'publish Fedora-30 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"fedora-30.amd64"}'
    when:
      condition:
        any:
          success_fedora_30: fedora_30.result == 'success'
  fedora_29:
    type: build
    title: Build Fedora 29 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: fedora-29.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=fedora-29
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "fedora", true)
  fedora_29_webhook:
    title: 'publish Fedora-29 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"fedora-29.amd64"}'
    when:
      condition:
        any:
          success_fedora_29: fedora_29.result == 'success'
  centos_8:
    type: build
    title: Build CentOS 8 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: centos-8.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=centos-8
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "centos", true)
  centos_8_webhook:
    title: 'publish CentOS-8 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"centos-8.amd64"}'
    when:
      condition:
        any:
          success_centos_8: centos_8.result == 'success'
  centos_7:
    type: build
    title: Build CentOS 7 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: centos-7.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=centos-7
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "centos", true)
  centos_7_webhook:
    title: 'publish CentOS-7 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"centos-7.amd64"}'
    when:
      condition:
        any:
          success_centos_7: centos_7.result == 'success'
  centos_6:
    type: build
    title: Build CentOS 6 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: centos-6.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=centos-6
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "centos", true)
  centos_6_webhook:
    title: 'publish CentOS-6 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"centos-6.amd64"}'
    when:
      condition:
        any:
          success_centos_6: centos_6.result == 'success'
  rhel_8:
    type: build
    title: Build RHEL 8 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: rhel-8.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=rhel-8
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "rhel", true)
  rhel_8_webhook:
    title: 'publish RHEL-8 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"rhel-8.amd64"}'
    when:
      condition:
        any:
          success_rhel_8: rhel_8.result == 'success'
  rhel_7:
    type: build
    title: Build RHEL 7 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: rhel-7.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=rhel-7
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "rhel", true)
  rhel_7_webhook:
    title: 'publish RHEL-7 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"rhel-7.amd64"}'
    when:
      condition:
        any:
          success_rhel_7: rhel_7.result == 'success'
  opensuse_tumbleweed_latest:
    type: build
    title: Build OpenSUSE Tumbleweed RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: opensuse_tumbleweed-latest.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=opensuse_tumbleweed-latest
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "opensuse", true)
  opensuse_tumbleweed_latest_webhook:
    title: 'publish OpenSUSE Tumbleweed rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"opensuse_tumbleweed-latest.amd64"}'
    when:
      condition:
        any:
          success_opensuse_tumbleweed_latest: opensuse_tumbleweed_latest.result == 'success'
  opensuse_leap_15:
    type: build
    title: Build OpenSUSE Leap 15 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: opensuse_leap-15.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=opensuse_leap-15
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "opensuse", true)
  opensuse_leap_15_webhook:
    title: 'publish OpenSUSE Leap 15 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"opensuse_leap-15.amd64"}'
    when:
      condition:
        any:
          success_opensuse_leap_15: opensuse_leap_15.result == 'success'
  opensuse_leap_42:
    type: build
    title: Build OpenSUSE Leap 42 RPMs and store to docker image
    image_name: rpms-${{CF_BRANCH_TAG_NORMALIZED}}
    tag: opensuse_leap-42.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=opensuse_leap-42
    no_cache: true
    no_cf_cache: true
    fail_fast: false
    when:
      condition:
        all:
          is_match_builder: match("${{base_image}}", "opensuse", true)
  opensuse_leap_42_webhook:
    title: 'publish OpenSUSE Leap 42 rpm files'
    image: 'codefreshplugins/webhook-plugin:latest'
    environment:
      - 'WEBHOOK_URL=http://rpm.kamailio.org/publish'
      - 'WEBHOOK_BODY={"image_name":"rpms-${{branch}}", "image_tag":"opensuse_leap-42.amd64"}'
    when:
      condition:
        any:
          success_opensuse_leap_42: opensuse_leap_42.result == 'success'
  print_error_message:
    image: alpine:latest
    title: Marking pipeline status
    commands:
    - echo "RPM build failed"
    - exit 1
    when:
      condition:
        any:
          failed_fedora_31: fedora_31.result == 'failure'
          failed_fedora_30: fedora_30.result == 'failure'
          failed_fedora_29: fedora_29.result == 'failure'
          failed_centos_8: centos_8.result == 'failure'
          failed_centos_7: centos_7.result == 'failure'
          failed_centos_6: centos_6.result == 'failure'
          failed_rhel_8: rhel_8.result == 'failure'
          failed_rhel_7: rhel_7.result == 'failure'
          failed_opensuse_tumbleweed_latest: opensuse_tumbleweed_latest.result == 'failure'
          failed_opensuse_15: opensuse_leap_15.result == 'failure'
          failed_opensuse_42: opensuse_leap_42.result == 'failure'
