version: "1.0"
steps:
  main_clone:
    type: "git-clone"
    title: "Cloning kamailio repository"
    repo: "sergey-safarov/kamailio"
    revision: "master"
  preps:
    type: freestyle
    title: Build preparation
    image: safarov/kamailio-builder:centos-7
    commands:
    - rm -f kamailio-*.src.rpm ${CF_VOLUME_PATH}/kamailio-*.src.rpm
    - make cfg
    - make -C pkg/kamailio src.rpm
    - mv kamailio-*.src.rpm ${CF_VOLUME_PATH}
    - cd ${CF_VOLUME_PATH}
    - rm -Rf kamailio
    - rm -f Dockerfile.store_rpm
    - wget -q https://raw.githubusercontent.com/kamailio/kamailio-ci/builder/builder/Dockerfile.store_rpm
    - cat Dockerfile.store_rpm
  centos_8:
    type: build
    title: Build CentOS 8 RPMs and store to docker image
    image_name: rpms-master
    tag: centos-8.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=centos-8
    no_cache: true
    no_cf_cache: true
    fail_fast: false
  centos_7:
    type: build
    title: Build CentOS 7 RPMs and store to docker image
    image_name: rpms-master
    tag: centos-7.amd64
    working_directory: ${{CF_VOLUME_PATH}}
    dockerfile: Dockerfile.store_rpm
    build_arguments:
      - builder_tag=centos-7
    no_cache: true
    no_cf_cache: true
    fail_fast: false
  print_error_message:
    image: alpine:latest
    title: Marking pipeline status
    commands:
    - echo "RPM build failed"
    - exit 1
    when:
      condition:
        any:
          failed_centos_7: centos_7.result == 'failure'
          failed_centos_8: centos_8.result == 'failure'
